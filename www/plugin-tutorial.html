<html>
<head>
  <style>
    dt {
      font-weight: bold;
      margin-left: 1em;
    }
    pre {
      border: 1px dashed black;
      padding: 0.5em;
    }
  </style>
</head>
<body><div class=app>
<h1>Plugin Tutorial</h1>

<p>
This document, together with the <a href="https://hudson.dev.java.net/source/browse/hudson/hudson/plugins/hello-world/">hello-world plugin</a>, shows you how to get started with the plugin development.

<h3>What Can Plugins Do?</h3>
<p>
Hudson defines extensibility points, which are interfaces or abstract classes that model an aspect of a build system. Those interfaces define contracts of what need to be implemented, and Hudson allows plugins to contribute those implementations. See <a href="extensible-points.html">this document</a> for more about extension points.
<p>
In this document, we'll be implementing a <a href="/nonav/javadoc/?hudson/tasks/Builder.html"><tt>Builder</tt></a> that says hello. (built-in builders include Ant, Maven, and shell script. Builders build a project.)


<h3>Setting Up Environment</h3>
<p>
	To develop a plugin, you need <a href="http://maven.apache.org/">Maven 2</a> and JDK 5.0 or later. If this is the first time you use Maven, <a href="http://maven.apache.org/guides/mini/guide-proxies.html">make sure Maven can download stuff over the internet.</a>

<p>
	Next, you'll have to have Maven download the necessary tools for you. Create an empty directory, download this <a href="https://hudson.dev.java.net/source/browse/*checkout*/hudson/hudson/tools/bootstrap/pom.xml">pom.xml</a> in there, and run "mvn package". This should download a bunch of tools.

<pre>
$ cd /tmp
$ wget https://hudson.dev.java.net/source/browse/*checkout*/hudson/hudson/tools/bootstrap/pom.xml
$ mvn package
$ rm pom.xml
</pre>

<p>
	Finally, add the following to your <tt>~/.m2/settings.xml</tt> (Windows users will find them in <tt>c:\Documents and Settings\<i>yourname</i>\.m2\settings.xml</tt>):

<pre>
&lt;settings>
  ...
  &lt;pluginGroups>
    ...
    &lt;pluginGroup>org.jvnet.hudson.tools&lt;/pluginGroup>
  &lt;/pluginGroups>
</pre>




<h3>Creating a New Plugin</h3>
<p>
	To start a new plugin, run the following maven command:

<!--
  You'd expect mvn hpi:create to work, but somehow it doesn't... any help appreciated.
-->
<pre>$ mvn org.jvnet.hudson.tools:maven-hpi-plugin:1.7:create</pre>

<p>
	This will ask you a few question, like the groupId (the maven jargon for the package name) and the artifactId (the maven jargon for your project name), then create a skeleton plugin from which you can start with. Make sure you can build this:

<pre>
$ cd <i>newly-created-directory</i>
$ mvn package
</pre>

<p>
	You should then generate IDE project files, so that you can develop a plugin productively.

<pre>
// if you are using IntelliJ
$ mvn -DdownloadSources=true idea:idea
// if you are using Eclipse
$ mvn -DdownloadSources=true eclipse:eclipse
</pre>
<p>
	NetBeans users should consider using <a href="http://mevenide.codehaus.org/m2-site/">this NetBeans module</a>.
	
	Due to <a href="https://bugs.eclipse.org/bugs/show_bug.cgi?id=163807">a bug in Eclipse</a>, Eclipse users will need to remove <tt>src/main/resources</tt> from the source folder list after projects are imported to the workspace. See <a href="https://hudson.dev.java.net/servlets/ReadMsg?list=users&msgNo=337">this e-mail thread</a> for more details.

<p>
	At this point, from your IDE, you should be able to see all files and all the needed libraries complete with their source code.

<h3>Plugin Workspace Layout</h3>
<p>
<a href="https://hudson.dev.java.net/source/browse/hudson/hudson/plugins/hello-world/">The plugin workspace</a> consists of the following major pieces:

<dl>
	<dt>pom.xml
	<dd>Maven uses it for building your plugin
	
	<dt>src/main/java
	<dd>Java source files of the plugin
	
	<dt>src/main/resources
	<dd>Jelly/Groovy views of the plugin. See <a href="architecture.html">this document</a> for more about it.
	
	<dt>src/main/webapp
	<dd>Static resources of the plugin, such as images and HTML files.
</dl>


<h3>Source Code</h3>
<p>
	Let's take a look at the source code. A plugin's main entry point is a <a href="/source/browse/hudson/hudson/plugins/hello-world/src/hudson/plugins/hello_world/PluginImpl.java?view=markup"><tt>PluginImpl</tt></a> class that extends from <a href="/nonav/javadoc/?hudson/Plugin.html"><tt>Plugin</tt></a>. Once Hudson detects your plugin (via its <tt>@plugin</tt> javadoc annotation &mdash; this gets copied into manifest during the build), it will create an instance, and invokes methods.
<p>
	Most of the time, a plugin class just registers extension points. See the source code for more about how a <tt>Builder</tt> is implemented and what it does.


<h3>Developing a Plugin</h3>
<p>
	Run the following command to launch Hudson with your plugin:
<pre>
$ export MAVEN_OPTS="-Xdebug -Xrunjdwp:transport=dt_socket,server=y,address=8000"
$ mvn hpi:run
</pre>
<p>
	If you open <tt>http://localhost:8080/</tt> in your browser, you should see the Hudson page running in Jetty. The <tt>MAVEN_OPTS</tt> portion launches this whole thing with the debugger port 8000, so you should be able to start a debug session to this port from your IDE.
<p>
	Once this starts running, keep it running. Jetty will pick up all the changes automatically.

<ol>
	<li>When you make changes to view files in <tt>src/main/resources</tt> or resource files in <tt>src/main/webapp</tt>, just hit F5 in your browser to see the changes.
	<li>When you change Java source files. Compile them in your IDE and Jetty should automatically redeploy Hudson to pick up those changes There is no need to run <tt>mvn</tt> at all.
</ol>


<h3>Distributing a Plugin</h3>
<p>
	To create a distribution image of your plugin, run the following Maven goal:
<pre>
$ mvn package
</pre>
<p>
	This should create <tt>target/*.hpi</tt> file. Other users can use Hudson's web UI to upload this plugin to Hudson (or place it in <tt>$HUDSON_HOME/plugins</tt>.)


<h3>Other Tips</h3>

<ol>
	<li>Consider running Maven like <tt>mvn -o ...</tt> to avoid hitting repositories every time. This will make various operations considerably faster.
	<li>Subscribe to <tt>users@hudson.dev.java.net</tt> from <a href="https://hudson.dev.java.net/servlets/ProjectMailingListList">here</a> so that we can get in touch with you.
	<li>When you bump up the version of Hudson you depend on, make sure to run <tt>mvn clean</tt> once, in particular to delte <tt>target/work</tt> that Jetty uses. Otherwise your Jetty may continue to pick up old left-over jar files.
</ol>

</div></body>
</html>
